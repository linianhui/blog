<style>
  th {
    text-align: center;
  }

  td {
    text-align: right;
  }

  .cell {
    padding: 0 !important;
  }

  .input-fieldset section {
    margin: 6px 0;
  }

  .form-name,
  .form-input {
    position: relative;
    display: inline-block;
    vertical-align: middle;
  }

  .form-name {
    width: 5em;
    text-align: right;
  }

  .form-input {
    margin-left: 1em;
  }

  .el-collapse {
    border: unset;
  }

  .el-collapse-item__wrap,
  .el-collapse-item__header {
    border: unset;
  }

  .el-input-group__prepend {
    padding: 0;
  }

  fieldset {
    border: unset;
    box-shadow: 0 0 2px #ccc;
    max-width: 100%;
    min-width: 100%;
    margin-top: 1em;
    box-sizing: border-box;
  }

  legend {
    background-color: #FFF;
    color: #909399;
  }

  .salary-wrapper {
    overflow-x: auto;
    max-width: 100%;
  }

  .salary-pre {
    font-family: unset;
    font-size: 0;
    margin: 0;
  }

  .salary-table {
    width: 100%;
    margin: 0;
    font-size: 14px;
  }

  .row-data {
    color: #666;
    font-family: monospace, Courier, 'Courier New'
  }

  .row-data:hover {
    background-color: #eee;
    cursor: pointer;
  }

  .insurance-table input {
    min-width: 2em;
    max-width: 6em;
    text-align: right;
  }
</style>
<div id="app">
  <fieldset class="input-fieldset">
    <legend>参数区域</legend>
    <section>
      <div class="form-name">
        <label for="salary">
          税前月工资
        </label>
      </div>
      <div colspan="2" class="form-input">
        <el-input-number id="salary" v-model="amount" step="1000" placeholder="请输入税前月工资">
        </el-input-number>
      </div>
    </section>
    <section>
      <div class="form-name">
        <label for="month">
          月数
        </label>
      </div>
      <div colspan="2" class="form-input">
        <el-input-number id="month" v-model="month" :min="1" :max="100" placeholder="请输入月数"></el-input-number>
      </div>
    </section>
    <section>
      <div class="form-name">
        <label for="insurance">
          社保基数
        </label>
      </div>
      <div class="form-input">
        <el-collapse>
          <el-collapse-item>
            <template slot="title">
              <el-select id="insurance" v-model="insuranceName" :popper-append-to-body="false"
                @change="onInsuranceNameChange">
                <el-option v-for="item in insuranceNameList" :key="item" :label="item" :value="item">
                </el-option>
              </el-select>
              &nbsp;&nbsp;
              <i class="header-icon el-icon-info">
                &nbsp;社保基数：{{insurance.min | CNY}} ~ {{insurance.max | CNY}}
              </i>
            </template>
            <table class="insurance-table">
              <tr class="row-header">
                <th>社保类型</th>
                <th>最低基数</th>
                <th>最高基数</th>
                <th>个人缴纳</th>
                <th>公司缴纳</th>
              </tr>
              <tr v-for="item in insurance.items" class="row-data">
                <td>{{item.name}}</td>
                <td>￥<input v-model="item.min"></td>
                <td>￥<input v-model="item.max"></td>
                <td><input v-model="item.personalPercentage">%</td>
                <td><input v-model="item.corporationPercentage">%</td>
              </tr>
            </table>
          </el-collapse-item>
        </el-collapse>
      </div>
    </section>
    <section>
      <div class="form-name">
        <label for="rate">税率表</label>
      </div>
      <div class="form-input">
        <el-collapse>
          <el-collapse-item>
            <template slot="title">
              <el-select id="rate" v-model="rateName" :popper-append-to-body="false">
                <el-option v-for="item in rateNameList" :key="item" :label="item" :value="item">
                </el-option>
              </el-select>
              &nbsp;&nbsp;
              <i class="header-icon el-icon-info">
                &nbsp;免征额：{{rate.exempted | CNY}}
              </i>
            </template>
            <table>
              <tr class="row-header">
                <th>范围</th>
                <th>税率</th>
                <th>速算扣除数</th>
              </tr>
              <tr v-for="item in rate.items" class="row-data">
                <td>
                  <span>
                    {{item.min | CNY}} ~
                    <span v-if="item.max">{{item.max | CNY}}</span>
                    <span v-else>￥∞</span>
                  </span>
                </td>
                <td>
                  {{item.rate}}%
                </td>
                <td>
                  {{item.quickDeduction | CNY}}
                </td>
              </tr>
            </table>
          </el-collapse-item>
        </el-collapse>
      </div>
    </section>
    <section>
  </fieldset>

  <fieldset>
    <legend>结果区域-年合计</legend>
    <table>
      <tr class="row-data">
        <td>税前</td>
        <td>{{amount | CNY}}(工资)</td>
        <td>*</td>
        <td>{{month}}(月)</td>
        <td>=</td>
        <td>{{salarys.summary.last.baseYTD | CNY}}</td>
        <td>+</td>
        <td>{{salarys.summary.last.insurances.corporationYTD | CNY}}(公司社保)</td>
        <td>=</td>
        <td>{{salarys.summary.last.corporationYTD | CNY}}(公司支出)</td>
      </tr>
      <tr class="row-data">
        <td colspan="6">-</td>
        <td colspan="4">-</td>
      </tr>
      <tr class="row-data">
        <td>税后</td>
        <td>{{salarys.summary.last.actualYTD | CNY}}(税后YTD) </td>
        <td>+</td>
        <td>{{salarys.summary.公积金SumYTD| CNY}}(公积金YTD)</td>
        <td>=</td>
        <td colspan="5">{{salarys.summary.totalActualYTD | CNY}}</td>
      </tr>
      <tr class="row-data">
        <td colspan="6">=</td>
        <td colspan="4">=</td>
      </tr>
      <tr class="row-data">
        <td>差额</td>
        <td colspan="5">{{salarys.summary.personalDiffYTD | CNY}}</td>
        <td colspan="4">{{salarys.summary.corporationDiffYTD | CNY}}</td>
      </tr>
    </table>
  </fieldset>

  <fieldset>
    <legend>结果区域-月列表</legend>
    <div class="salary-wrapper">
      <pre class="salary-pre">
        <table class="salary-table">
          <tr class="row-header">
            <th style="width: 5em;">月份</th>
            <th>税前</th>
            <th>税前YTD</th>
            <th style="width: 6em;">免征额YTD</th>
            <th style="width: 7em;">社保个人YTD</th>
            <th>税基YTD</th>
            <th style="width: 3em;">税率</th>
            <th>个税</th>
            <th>个税YTD</th>
            <th>税后</th>
            <th>税后YTD</th>
          </tr>
          <template v-for="item in salarys.items.reverse()">
            <tr class="row-data">
              <td v-if="item.month > 12">{{item.months}}个月奖金</td>
              <td v-else>{{item.month}}月</td>
              <td>{{item.base | CNY}}</td>
              <td>{{item.baseYTD | CNY}}</td>
              <td>{{item.exemptedYTD | CNY}}</td>
              <td>{{item.insurances.personalYTD | CNY}}</td>
              <td>{{item.taxableYTD | CNY}}</td>
              <td>{{item.rate.rate}}%</td>
              <td>{{item.tax | CNY}}</td>
              <td>{{item.taxYTD | CNY}}</td>
              <td>{{item.actual | CNY}}</td>
              <td>{{item.actualYTD | CNY}}</td>
            </tr>
          </template>
        </table>
      </pre>
    </div>
  </fieldset>
</div>
<script src="rates.js"></script>
<script src="insurances.js"></script>
<script src="calculator.js"></script>
<script type="text/javascript">
  const rateNameList = Object.keys(rates);
  const rateName = rateNameList[0];
  const insuranceNameList = Object.keys(insurances);
  const insuranceName = insuranceNameList[0];

  new Vue({
    el: "#app",
    data: function () {
      return {
        amount: 5000,
        month: 12,
        rateNameList: rateNameList,
        rateName: rateName,
        rate: rates[rateName],
        insuranceNameList: insuranceNameList,
        insuranceName: insuranceName,
        insurance: insurances[insuranceName]
      }
    },
    filters: {
      CNY: function (value) {
        return currency(
          value || 0,
          {
            symbol: "",
            separator: ",",
            precision: 2
          })
          .format();
      }
    },
    computed: {
      salarys() {
        var items = buildSalaryList(
          parseInt(this.amount, 10),
          this.month,
          this.insurance,
          this.rate
        );
        calculateOneYear(items);
        items.shift();
        log("calculate salarys", items);

        var summary = buildSummary(items);
        log("calculate salarys year summary", summary);

        return {
          items: items,
          summary: summary
        };
      }
    },
    methods: {
      onRateNameChange(name) {
        this.rate = rates[name];
      },
      onInsuranceNameChange(name) {
        this.insurance = insurances[name];
      }
    }
  })
</script>